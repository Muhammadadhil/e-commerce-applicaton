<%-include('../layouts/header')%>



<!-- Checkout Section Start -->
<div class="section section-padding mt-5">
    <div class="container">
    
        <div class="checkout-info">
            <p class="info-header">
                <i class="fa fa-exclamation-circle"></i> Have a coupon?
                <a data-bs-toggle="collapse" href="#coupon">Click here to enter your code</a>
            </p>

            <div class="collapse" id="coupon">
                <div class="card-body">
                    <form action="">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="single-form">
                                    <input type="text" placeholder="Coupon code" id="couponCode" required />
                                    <span id="couponCodeError" class="text-danger"></span>
                                    <span id="couponCodeSuccess" class="text-success "></span>

                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="single-form">
                                    <button onclick="applyCoupon(event)" class="btn btn-primary btn-hover-dark">Coupon</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="row">
                   <div class="col-lg-3 mt-4 mb-4">
                        <%if(coupons){%>
                            <%coupons.forEach((coupon)=>{%>
                                <div class="card coupon-card border-2 rounded-3 mb-2">
                                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                                        <i class="fa fa-gift" aria-hidden="true"></i>
                                        <h5 class="coupon-tag"><%=coupon.couponName%></h5>
                                        <p class="coupon-text">
                                            Code: <b><%=coupon.couponCode%></b> <br />
                                            Discount Amount: <b><%=coupon.discountAmount%> </b><br />
                                            Critria Amount: <b><%=coupon.criteriaAmount%></b> 
                                            
                                        </p>
                                        <p class="text-muted ">
                                            Copy the code
                                        </p>
                                    </div>
                                </div>
                            <%})%>
                        <%}%>
                    </div>
                    </div>
                </div>  
            </div>
        </div>
        <div class="single-form checkbox-checkbox mb-5">
            <input type="checkbox" id="shipping" />
            <label for="shipping">
                <span></span> Ship to a different
                address?</label>
        </div>

        <div class="checkout-shipping">
            <div class="row">
                <div class="col-lg-7">
                    <!-- Checkout Form Start -->
                    <div class="checkout-form">
                        <div class="checkout-title">
                            <h4 class="title">Billing Address new:</h4>
                        </div>

                        <div class="row">
                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="nameeee" id="name" placeholder="name" />
                                    <p id="nameError" class="error-message"></p>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="single-form">
                                    <input type="text" name="phone" id="phone" placeholder="mobile number" />
                                    <p id="mobileError" class="error-message"></p>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="single-form">
                                    <input type="text" name="email" id="email" placeholder="Email address" />
                                    <p id="emailError" class="error-message"></p>
                                </div>
                            </div>

                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="address" id="address" placeholder="Flat, House no., Building, Company, Apartment" />
                                    <p id="addressError" class="error-message"></p>
                                </div>
                            </div>

                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="landmark" id="landmark" placeholder="Landmark" value="" />
                                    <p id="landmarkError" class="error-message"></p>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="city" id="city" placeholder="city" />
                                    <p id="pincodeError" class="error-message"></p>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="state" id="state" placeholder="state" />
                                    <p id="pincodeError" class="error-message"></p>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="single-form">
                                    <input type="text" name="pincode" id="pincode" placeholder="Pincode" />
                                    <p id="pincodeError" class="error-message"></p>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <div class="single-form">
                        <button type="button" onclick="addAddress()" class="btn btn-primary btn-hover-dark d-block">add address</button>
                    </div>

                    <!-- Checkout Form End -->
                </div>
            </div>
        </div>
        <form id="addAddress" method="post" action="/placeOrder">
        <%if(!userAddresses?.address.length<1){%>
            <div class="col checkout-form">
                <div class="checkout-title">
                    <h4 class="title">Billing Address</h4>
                </div>
                <div class="row">
                    <div class="col-lg-7">
                        <%if(userAddresses){%>
                            <%userAddresses?.address.forEach((address,index)=>{%>
                                <div class=" text-start " >
                                    <br>
                                    <div class="card card-dashboard">
                                        <div class="card-body" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1)">
                                            
                                            <input type="radio" id="addressId" name="addressId" value="<%=address._id%>" <%if(index==0){%> checked <%}%> >
                                            <p> 
                                                Name:  <%=address.name%> <br>
                                                Mobile:  <%=address.phone%>  <br>    
                                                City:  <%=address.city%><br>       
                                                Email:   <%=address.email%><br>      
                                                Landmark:   <%=address.landmark%><br>       
                                                Address:    <%=address.address%><br>        
                                                Landmark:   <%=address.state%><br>      
                                                Pincode:    <%=address.pincode%><br>
                                            </p>  
                                            
                                                <a class="g-4" onclick="getAddressFeilds('<%=address._id%>')" data-bs-toggle="modal" data-bs-target="#editAddressModal" id="editAddress"><i
                                                    class="fa fa-edit"></i></a>
                                                <a class="g-4" onclick="removeAddress('<%=address._id%>')" id="removeAddress"><i
                                                    class="fa fa-trash"></i></a>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <%}%>
                    </div>      
                
        
                <%}else{%>
                    
                        <div class="row">
                            <div class="col-lg-7">
                                <!-- Checkout Form Start -->
                                <div class="checkout-form">
                                    <div class="checkout-title">
                                        <h4 class="title">Billing Address new:</h4>
                                    </div>
            
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="name" id="name" placeholder="name" />
                                                <p id="nameError" class="error-message"></p>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="single-form">
                                                <input type="text" name="phone" id="phone" placeholder="mobile number" />
                                                <p id="mobileError" class="error-message"></p>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="single-form">
                                                <input type="text" name="email" id="email" placeholder="Email address" />
                                                <p id="emailError" class="error-message"></p>
                                            </div>
                                        </div>
            
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="address" id="address" placeholder="Flat, House no., Building, Company, Apartment" />
                                                <p id="addressError" class="error-message"></p>
                                            </div>
                                        </div>
            
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="landmark" id="landmark" placeholder="Landmark" value="" />
                                                <p id="landmarkError" class="error-message"></p>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="city" id="city" placeholder="city" />
                                                <p id="pincodeError" class="error-message"></p>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="state" id="state" placeholder="state" />
                                                <p id="pincodeError" class="error-message"></p>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="single-form">
                                                <input type="text" name="pincode" id="pincode" placeholder="Pincode" />
                                                <p id="pincodeError" class="error-message"></p>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                                <div class="single-form">
                                    <button type="button" onclick="addAddress()" class="btn btn-primary btn-hover-dark d-block">add address</button>
                                </div>

                                <!-- Checkout Form End -->
                        </div>
                            
                <%}%>
        
                <!-- order area -->

                <div class="col-lg-5 mb-5">
                    <div class="checkout-order">
                        <div class="checkout-title">
                            <h4 class="title">Your Order</h4>
                        </div>

                        <div class="checkout-order-table table-responsive">
                            <table class="table" id="reloadPart">
                                <thead>
                                    <tr>
                                        <th class="Product-name fw-bold">Product</th>
                                        <th class="Product-price">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%if(cartDetails){%>
                                        <%cartDetails.product.forEach((product,i)=>{%>
                                            <tr>
                                                <td class="Product-name">
                                                    <p><%=product.productId.name%> × <%=product.quantity%></p>
                                                </td>
                                                <td class="Product-price">
                                                    <p>₹<%=product.productId.p%></p>
                                                </td>
                                            </tr>
                                            <%})%>
                                    <%}%>
                                    
                                </tbody>
                                <tfoot >
                                    
                                    <tr>
                                        <td class="Product-name">
                                            <p class="fw-bold ">total</p>
                                        </td>
                                        <td class="Product-price">
                                            <p id="subTotalAmount">₹<%=subTotal%></p>
                                        </td>
                                    </tr>
                                    
                                    <!-- <tr>
                                        <td class="Product-name">
                                            <p class="fw-bold ">Shipping</p>
                                        </td>
                                        <td class="Product-price"> 
                                            <ul class="shipping-list">
                                                <li class="radio">
                                                    <input type="radio" name="shipping" value="flat rate" id="radio1"  />
                                                    <label for="radio1"><span></span> Flat Rate</label>
                                                </li>
                                                <li class="radio">
                                                    <input type="radio" name="shipping" value="free shipping" id="radio2" checked/>
                                                    <label for="radio2"><span></span> Free Shipping</label>
                                                </li>
                                                <li class="radio">
                                                    <input type="radio" name="shopping"  value="local pickup" id="radio3" />
                                                    <label for="radio3"><span></span> Local Pickup</label>
                                                </li>
                                            </ul>
                                        </td>
                                    </tr> -->
                                    <div >
                                    <%if(cartDetails.couponDiscount>0){%>
                                        <tr>
                                            <td class="Product-name ">
                                                <p class="fw-bold ">Subtotal</p>
                                            </td>
                                            <td class="Product-price">
                                                <p>original amount ₹<span class="old-price"><%=subTotal%></span></p>
                                                <p>coupon discounted amount:  ₹<%=subTotal-cartDetails.couponDiscount%></p>
                                            </td>
                                        </tr>
                                    <%}else{%>
                                        <tr>
                                            <td class="Product-name">
                                                <p class="fw-bold ">Subtotal</p>
                                            </td>
                                            <td class="Product-price">
                                                <p>₹<%=subTotal%></p>
                                            </td>
                                        </tr>
                                    <%}%>
                                    </div>
                                </tfoot>
                            </table>
                        </div>
                        

                        <div class="checkout-payment">
                            <ul>
                                <li>
                                    <div class="single-payment">
                                        <div class="payment-radio radio">
                                            <p class="Product-name fw-bold ">Payment method</p>
                                            
                                            <input type="radio" name="paymentmethod" value="online" id="bank" />
                                            <label for="bank"><span></span>Online-Razorpay</label>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="single-payment">
                                        <div class="payment-radio radio">
                                            <input type="radio" name="paymentmethod" value="cash on delivery" id="cash" />
                                            <label for="cash"><span></span> Cash on Delivery</label>

                                            <div class="payment-details">
                                                <p>Pay with cash upon delivery.</p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <span class="text-danger" id="paymentMethod-Error"></span>
                            </ul>

                            <div class="single-form">
                                <button type="button" onclick="placeOrder()" class="btn btn-primary btn-hover-dark d-block">Place Order</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
    </div>
</div>
<!-- Checkout Section End -->
<!-- Edit address modal  -->

<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="">
                <h5 class="modal-title" id="exampleModalLabel">Edit address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" >
                    <div class="row d-flex justify-content-center">
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="name" />
                                <p id="nameError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="phone" placeholder="mobile number" />
                                <p id="mobileError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="email" placeholder="Email address" />
                                <p id="emailError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="address" placeholder="street address"/>
                                <p id="addressError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="landmark" placeholder="Landmark" value="" />
                                <p id="landmarkError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="state" placeholder="State" />
                                <p id="stateError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="single-form">
                                <input type="text" name="city" placeholder="City" />
                                <p id="cityError" class="error-message"></p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="single-form">
                                <input type="text" name="pincode" placeholder="Pincode" />
                                <p id="pincodeError" class="error-message"></p>
                            </div>
                        </div>
                    </div>
                    <input type="text" name="addressId" hidden />

                    <p id="editAddressError" class="error-message text-danger "></p>

                    <div class="">
                        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="editAddress()" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Edit address modal end-->


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    function applyCoupon(event){

        event.preventDefault();

        const code=document.getElementById('couponCode').value
        const subTotalAmount=document.getElementById('subTotalAmount').textContent;
        console.log('subTotalAmount:',subTotalAmount );
        const errorElement=document.getElementById('couponCodeError');
        const successElement=document.getElementById('couponCodeSuccess');

        
        fetch(`/applyCoupon?cpn=${code}&total=${subTotalAmount}`)
        .then((res)=>res.json())
        .then((data)=>{
            if(data.verify){
                successElement.innerHTML=`${data.couponData.couponName} coupon applied for the current order`
                const totalPart=document.getElementById('reloadPart');
                $('#reloadPart').load('/checkout #reloadPart ');
 
            }else if(data.added=='already used'){
                errorElement.innerHTML='Coupon already used';
            }
            else if(data.coupon=='criteria didnot reached'){
                errorElement.innerHTML=`this coupon is available for minimum purchase of ${data.couponData.criteriaAmount}`;

            }else if(!data.verify){
                errorElement.innerHTML='Enter correct coupon code';
            }
            
        })
    }
</script>

<script>
    function placeOrder(){
        
        const addressId=document.getElementById('addressId').value;
        const paymentMethodElement=document.querySelector('.checkout-payment input[name="paymentmethod"]:checked');
        let paymentMethod='';
        
        if (!paymentMethodElement) {
            const errorMessageElement = document.getElementById('paymentMethod-Error');
            errorMessageElement.textContent = 'Please select a payment method.';
            
        } else {
            const errorMessageElement = document.getElementById('paymentMethod-Error');
            paymentMethod=paymentMethodElement.value;
            errorMessageElement.textContent = '';
        }
        
        fetch('/placeOrder',{
            method:'POST',
            headers:{
                "content-type": "application/json;charset=utf-8"
            },
            body:JSON.stringify({
                addressId,
                paymentMethod
            })
        })
        .then((response)=>response.json())
        .then((data)=>{
            if(data.codSuccess){
                window.location.href=`/orderSuccess?id=${data.orderId}`
            }else if(data.onlineSuccess){
                console.log('data.order:',data.order);
                razorpayPayment(data.order);
            }
        })
        .catch((err)=>{
            if (err) throw err
        })
    }

    function razorpayPayment(order){

        var options = {
            "key": "rzp_test_bHCQ2sAI4219I7", 
            "amount": order.amount, 
            "currency": "INR",
            "name": "furbar", 
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, 
            // "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
            "handler": function (response){                          //handler after payment success
                console.log('response:',response);
                verifyPayment(response,order);
            },
            "prefill": { 
                "name": "muhammad adhil", 
                "email": "aadhi@gmail.com", 
                "contact": "9000090000" 
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {  
                "color": "#3399cc"
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
            alert(response.error.description);
            // window.location.href=`/detailsOrder?id=${order.receipt}`
        });

        rzp1.open();
    }

    function verifyPayment(response,order){
        fetch('/verifyPayment',{
            method:"POST",
            headers:{
                "content-type": "application/json;charset=utf-8"
            },
            body:JSON.stringify({
                response,
                order
            })
        })
        .then((res)=>res.json())
        .then((data)=>{
            if(data.statusChanged){
                window.location.href=`/orderSuccess?id=${data.orderId}`
            }
        })   
    }

</script>

<script>

    function editAddress(){

        console.log('reached here in edit address');
        const name=document.querySelector('#editAddressModal input[name="name"]').value ;
        const phone=document.querySelector('#editAddressModal input[name="phone"]').value;
        const email=document.querySelector('#editAddressModal input[name="email"]').value;
        const address=document.querySelector('#editAddressModal input[name="address"]').value;
        const landmark=document.querySelector('#editAddressModal input[name="landmark"]').value;
        const state= document.querySelector('#editAddressModal input[name="state"]').value ;
        const city= document.querySelector('#editAddressModal input[name="city"]').value ;
        const pincode=document.querySelector('#editAddressModal input[name="pincode"]').value ;
        const addressId=document.querySelector('#editAddressModal input[name="addressId"]').value;

        console.log('bod:',name,phone,email,address,landmark,state,city,pincode,addressId);
        const commonError=document.getElementById('editAddressError');

        fetch("/editAddress", {
            method: "POST",
            headers: {
                "content-type": "application/json;charset=utf-8",
            },
            body: JSON.stringify({
                name,phone,email,address,landmark,state,city,pincode,addressId
            }),
        })
        .then((res) => res.json())
        .then((data) => {
            console.log("heyyyyyyyyyyyy",data);
            if(data.edited){
                console.log('heyyy brroooo');
                window.location.reload();
            }else if(!data.validate && data.message) {
                let errorMessage = "";
                data.message.forEach(detail => {
                    errorMessage += `${detail.message}<br>`;
                });
                commonError.innerHTML = errorMessage;
            }
        })
        .catch((error) => {
            console.log(error);
        });
    }



    function getAddressFeilds(addressId) {
        console.log("reched edit address::::::::::::");

        const response = fetch("/getAddress", {
            method: "POST",
            headers: {
                "content-type": "application/json;charset=utf-8",
            },
            body: JSON.stringify({
                addressId,
            }),
        });
        response
            .then((res) => res.json())
            .then((data) => {
                console.log(data.currentAddress);
                populateModalField(data.currentAddress);
                $("#editAddressModal").modal("show");
            });
    }
    
    function populateModalField(addressData) {
        document.querySelector('#editAddressModal input[name="name"]').value = addressData.name;
        document.querySelector('#editAddressModal input[name="phone"]').value = addressData.phone;
        document.querySelector('#editAddressModal input[name="email"]').value = addressData.email;
        document.querySelector('#editAddressModal input[name="address"]').value = addressData.address;
        document.querySelector('#editAddressModal input[name="landmark"]').value = addressData?.landmark || "! no landmark given";
        document.querySelector('#editAddressModal input[name="state"]').value = addressData.state;
        document.querySelector('#editAddressModal input[name="city"]').value = addressData.city;
        document.querySelector('#editAddressModal input[name="pincode"]').value = addressData.pincode;
        document.querySelector('#editAddressModal input[name="addressId"]').value = addressData._id;
    }

    function addAddress() {
        const name = document.getElementById("name").value;
        const phone = document.getElementById("phone").value;
        const email = document.getElementById("email").value;
        const address = document.getElementById("address").value;
        const landmark = document.getElementById("landmark").value;
        const city = document.getElementById("city").value;
        const state = document.getElementById("state").value;
        const pincode = document.getElementById("pincode").value;

        console.log("add address body:", name, phone, email, address, landmark, state, city, pincode);

        fetch("/addAddress", {
            method: "POST",
            headers: {
                "content-type": "application/json;charset=utf-8",
            },
            body: JSON.stringify({
                name,
                phone,
                email,
                address,
                landmark,
                state,
                city,
                pincode,
            }),
        })
            .then((res) => res.json())
            .then((data) => {
                if (data.added) {
                    window.location.reload();
                } else if(!data.validate){
                    alert('joi error')
                    console.log('joi error details:',data.message)
                }
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function removeAddress(addressId) {
        console.log("reched delete address::::::::::::");

        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!",
        }).then((result) => {   

            if (result.isConfirmed) {
                fetch("/removeAddress", {
                    method: "POST",
                    headers: {
                        "content-type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({
                        addressId,
                    }),
                }).then( async(res) => {
                    if (res.ok) {
                       await Swal.fire({
                            title: "Removed!",
                            text: "Your address is removed.",
                            icon: "success",
                        });
                        window.location.reload();

                    } else {
                        Swal.fire({
                            title: " Not Deleted!",
                            text: "there is a problem while delete",
                            icon: "error",
                        });
                    }
                });
            }
        });
    }
</script>

<%-include('../layouts/footer')%>
